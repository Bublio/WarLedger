<!DOCTYPE html>
<html>
<head>
    <title>War Ledger | Project Focus</title>
    <style>
        :root {
            --bg-dark: #0f0f12; --sidebar-bg: #16161d; --card-bg: #1c1c24;
            --accent-gold: #d4a017; --text-main: #ffffff; 
            --text-dim: #cccccc; 
            --bar-owned: #d4a017; --bar-built: #3498db; --bar-primed: #9b59b6; --bar-painted: #2ecc71;
            
            --color-hero: #ff9f43; --color-character: #fb6340; --color-battleline: #2dce89; 
            --color-fire_support: #3498db; --color-close_support: #f1c40f; --color-vehicle: #8965e0;
            --border-color: #2d2d3a;
        }

        /* Toned-down Light Mode (Soft Paper Palette) */
        body.light-mode {
            --bg-dark: #eef0f2;      /* Muted soft grey background */
            --sidebar-bg: #e2e5e9;   /* Slightly darker sidebar */
            --card-bg: #f9f9fb;      /* Off-white cards for gentle contrast */
            --text-main: #2c3e50;    /* Deep charcoal instead of black */
            --text-dim: #636e72;     /* Softer secondary text */
            --border-color: #d1d8df; /* Subtle borders */
        }
        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; transition: background 0.3s; }
        .logo { color: var(--accent-gold); font-weight: bold; margin-bottom: 30px; font-size: 1.1rem; letter-spacing: 2px; text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .nav-item { padding: 14px; color: var(--text-dim); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .nav-item.active { background: rgba(212, 160, 23, 0.1); color: var(--accent-gold); border: 1px solid var(--accent-gold); }

        .view { display: none; flex: 1; height: 100%; overflow-y: auto; padding: 40px; box-sizing: border-box; scroll-behavior: smooth; }
        .view.active { display: block; }

        /* DASHBOARD SUMMARY CARDS */
        .summary-card { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid var(--border-color); cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .summary-card:hover { border-color: var(--accent-gold); transform: translateY(-3px); }
        .summary-card h3 { margin: 0; font-size: 1.2rem; }
        .summary-meta { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 15px; font-weight: 600; }

        /* HEATMAP STYLES */
        .heatmap { display: flex; gap: 2px; height: 3px; margin: 8px 0; width: 100%; border-radius: 10px; overflow: hidden; }
        .seg { flex: 1; background: var(--border-color); transition: 0.3s; }
        .seg.owned { background: var(--bar-owned); }
        .seg.built { background: var(--bar-built); }
        .seg.primed { background: var(--bar-primed); }
        .seg.painted { background: var(--bar-painted); }

        /* GROUP HEADERS */
        .group-header { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; margin: 25px 0 10px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; display: flex; align-items: center; gap: 10px; grid-column: 1 / -1; }
        .group-header span { color: #888; font-weight: 400; }

        .unit-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }

        .unit-card { background: var(--card-bg); border-radius: 12px; padding: 12px; border: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; }
        .unit-card.focused { border-color: var(--accent-gold); box-shadow: 0 0 10px rgba(212, 160, 23, 0.1); }
        .unit-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .unit-name { font-size: 1rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; display: inline-block; }
        .unit-meta { font-size: 0.75rem; color: var(--text-dim); }

        .badge { font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; margin-left: 5px; vertical-align: middle; }
        .badge-hero { background: rgba(255, 159, 67, 0.1); color: var(--color-hero); }
        .badge-character { background: rgba(251, 99, 64, 0.1); color: var(--color-character); }
        .badge-battleline { background: rgba(45, 206, 137, 0.1); color: var(--color-battleline); }
        .badge-fire_support { background: rgba(52, 152, 219, 0.1); color: var(--color-fire_support); }
        .badge-close_support { background: rgba(241, 196, 15, 0.1); color: var(--color-close_support); }
        .badge-vehicle { background: rgba(137, 101, 224, 0.1); color: var(--color-vehicle); }

        .comp-context { font-size: 0.55rem; color: var(--accent-gold); font-weight: 900; text-transform: uppercase; margin-bottom: 4px; display: block; opacity: 0.8; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 30px; }
        .widget { background: var(--card-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .widget-val { font-size: 1.15rem; font-weight: 900; color: var(--text-main); margin-bottom: 2px; }
        .widget-label { font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        .w-pts { border-left: 3px solid var(--bar-painted); }
        .w-val { border-left: 3px solid var(--bar-owned); }
        .w-eff { border-left: 3px solid #636e72; }

        .hobby-row { display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--border-color); margin-top: auto; }
        .hobby-item { font-size: 0.7rem; color: var(--text-dim); display: flex; align-items: center; gap: 4px; cursor: pointer; }
        
        .btn-gold { background: var(--accent-gold); color: #000; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; }
        .input-panel { background: var(--sidebar-bg); padding: 25px; border-radius: 15px; border: 2px solid var(--accent-gold); margin-bottom: 30px; display: none; }
        input, select { background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; margin: 5px; border-radius: 6px; }
        .action-btn { background: none; border: none; color: #777; cursor: pointer; transition: 0.2s; font-size: 0.9rem; margin-left: 4px; padding: 2px; }
        .action-btn.active-star { color: var(--accent-gold); opacity: 1; }
        
        .comp-nav-item { padding: 10px; border-radius: 8px; cursor: pointer; color: var(--text-dim); margin-bottom: 8px; display: flex; align-items: center; transition: 0.2s; border: 1px solid transparent; }
        .comp-nav-item.active { color: var(--text-main); background: var(--bg-dark); border-color: var(--border-color); }
        
        .data-box { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .data-btn { background: var(--bg-dark); color: var(--text-dim); border: 1px solid var(--border-color); width: 100%; padding: 8px; border-radius: 6px; font-size: 0.65rem; text-transform: uppercase; cursor: pointer; margin-bottom: 5px; font-weight: bold; }
        .bar-label { display:flex; justify-content:space-between; font-size:0.6rem; font-weight:800; color:#aaa; text-transform:uppercase; }

        .theme-toggle { display: flex; align-items: center; gap: 10px; font-size: 0.65rem; font-weight: bold; color: var(--text-dim); cursor: pointer; margin-top: 15px; padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">‚öîÔ∏è WAR LEDGER</div>
        <div id="nav-dash" class="nav-item active" onclick="switchView('dashboard', this)">üìÇ Dashboard</div>
        <div id="nav-muster" class="nav-item" onclick="switchView('muster', this)">üìú Master Muster</div>
        <div id="nav-comp" class="nav-item" onclick="switchView('companies', this)">üõ°Ô∏è Companies</div>
        <div style="margin-top: 30px; overflow-y: auto; max-height: 35vh;">
            <p style="font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-left: 10px;">Deployments</p>
            <div id="comp-nav"></div>
            <button onclick="createNewCompany()" style="background:none; color:var(--accent-gold); border:1px dashed #444; width:100%; padding:10px; border-radius:8px; cursor:pointer; margin-top:10px;">+ New Company</button>
        </div>
        <div class="data-box">
            <button class="data-btn" onclick="exportData()">üì§ Backup Army (Copy)</button>
            <button class="data-btn" onclick="importData()">üì• Restore Army (Paste)</button>
            <div class="theme-toggle" onclick="toggleTheme()">üåì <span id="theme-text">Switch to Light Mode</span></div>
        </div>
    </div>

    <div id="dashboard" class="view active">
        <h1>Command Center</h1>
        <div class="stat-grid" id="global-widgets"></div>
        
        <div id="project-focus-section" style="display:none; margin-bottom: 40px;">
            <div class="group-header">‚≠ê Current Projects <span>(Focus List)</span></div>
            <div id="project-grid" class="unit-grid-container"></div>
        </div>

        <div class="group-header">üìä Strategic Summary</div>
        <div id="dash-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px;"></div>
    </div>

    <div id="muster" class="view">
        <h1>Master Muster</h1>
        <input type="text" id="musterSearch" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-main); padding: 12px 20px; border-radius: 10px; width: 100%; max-width: 400px; margin-bottom: 20px; font-size: 0.9rem; outline: none;" placeholder="Search by unit name..." onkeyup="renderMuster()">
        <div id="muster-container"></div>
    </div>

    <div id="companies" class="view">
        <div id="no-selection" style="text-align:center; margin-top:100px; color:var(--text-dim);">üõ°Ô∏è Select a detachment to manage units.</div>
        <div id="active-ui" style="display:none;">
            <button class="btn-gold" style="float:right;" onclick="openPanel()">+ Deploy Unit</button>
            <h1 id="active-title" style="margin-bottom: 25px;">Company</h1>
            <div class="stat-grid" id="local-widgets"></div>
            <div id="unitPanel" class="input-panel">
                <input type="text" id="uName" placeholder="Unit Name">
                <select id="uRole">
                    <option value="hero">Hero</option><option value="character">Character</option>
                    <option value="battleline">Battleline</option><option value="fire_support">Fire Support</option>
                    <option value="close_support">Close Support</option><option value="vehicle">Vehicle</option>
                </select>
                <input type="number" id="uModels" placeholder="Models" style="width:80px">
                <input type="number" id="uPts" placeholder="Pts" style="width:80px">
                <input type="number" id="uCost" placeholder="$" style="width:80px">
                <button class="btn-gold" onclick="saveUnit()">Confirm</button>
                <button onclick="togglePanel(false)" style="background:none; color:var(--text-main); border:none; cursor:pointer;">Cancel</button>
            </div>
            <div id="unitContainer"></div>
        </div>
    </div>

    <script>
        let army = JSON.parse(localStorage.getItem('warLedgerData')) || [];
        let activeIdx = null;
        let editingUnitIdx = null;

        window.onload = () => { 
            if(localStorage.getItem('lightMode') === 'enabled') toggleTheme(true);
            renderCompanyNav(); 
            updateDashboard(); 
        };

        function toggleTheme(initial = false) {
            const body = document.body;
            const isLight = initial ? true : !body.classList.contains('light-mode');
            
            if (isLight) {
                body.classList.add('light-mode');
                document.getElementById('theme-text').innerText = "Switch to Dark Mode";
                if(!initial) localStorage.setItem('lightMode', 'enabled');
            } else {
                body.classList.remove('light-mode');
                document.getElementById('theme-text').innerText = "Switch to Light Mode";
                localStorage.setItem('lightMode', 'disabled');
            }
        }

        function save() { 
            localStorage.setItem('warLedgerData', JSON.stringify(army)); 
            updateDashboard(); renderCompanyNav();
            if(activeIdx !== null) { renderUnits(); updateLocalWidgets(); }
        }

        function switchView(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (el) el.classList.add('active');
            if (id === 'muster') renderMuster();
            if (id === 'dashboard') updateDashboard();
            document.getElementById(id).scrollTop = 0;
        }

        function renderMuster() {
            const container = document.getElementById('muster-container');
            const search = (document.getElementById('musterSearch').value || "").toLowerCase();
            container.innerHTML = '';
            let muster = {};
            army.forEach(comp => {
                comp.units.forEach(u => {
                    const key = u.name.trim().toLowerCase();
                    if (!muster[key]) muster[key] = { name: u.name, models: 0, pts: 0, squads: 0, role: u.role };
                    muster[key].models += parseInt(u.models || 0, 10);
                    muster[key].pts += parseInt(u.pts || 0, 10);
                    muster[key].squads += 1;
                });
            });
            const sorted = Object.values(muster).filter(m => m.name.toLowerCase().includes(search)).sort((a,b) => a.name.localeCompare(b.name));
            if (sorted.length === 0) { container.innerHTML = '<p>No units found.</p>'; return; }
            let tableHTML = `<table class="muster-table" style="width:100%; border-collapse: collapse; margin-top: 10px;"><thead><tr style="text-align:left; color:#aaa; font-size: 0.7rem; text-transform: uppercase;"><th>Unit Name</th><th>Role</th><th>Squads</th><th>Models</th><th>Points</th></tr></thead><tbody>`;
            sorted.forEach(m => { tableHTML += `<tr style="border-bottom: 1px solid var(--border-color); height: 45px;"><td style="font-weight:bold; color:var(--text-main);">${m.name}</td><td><span class="badge badge-${m.role}">${m.role.replace('_', ' ')}</span></td><td style="color:var(--text-main);">${m.squads}</td><td style="color:var(--accent-gold); font-weight:800;">${m.models}</td><td style="color:var(--text-main);">${m.pts}</td></tr>`; });
            container.innerHTML = tableHTML + `</tbody></table>`;
        }

        function createUnitCardHTML(u, cIdx, uIdx, hideActions = false, compName = "") {
            const ppp = u.pts > 0 ? (u.cost / u.pts).toFixed(2) : "0.00";
            return `
                <div class="unit-card ${u.focused ? 'focused' : ''}">
                    ${compName ? `<span class="comp-context">${compName}</span>` : ''}
                    <div class="unit-top">
                        <div><span class="unit-name" title="${u.name}">${u.name}</span><span class="badge badge-${u.role}">${u.role.replace('_', ' ')}</span></div>
                        <div>
                            <button class="action-btn ${u.focused ? 'active-star' : ''}" onclick="toggleFocus(${cIdx}, ${uIdx})">‚òÖ</button>
                            ${!hideActions ? `
                                <button class="action-btn" onclick="duplicateUnit(${uIdx})">‚ùê</button>
                                <button class="action-btn" onclick="editUnit(${uIdx})">‚úé</button>
                                <button class="action-btn" onclick="delUnit(${uIdx})">‚úï</button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="unit-meta">${u.models || 0} Models ‚Ä¢ ${u.pts || 0} Pts ‚Ä¢ $${u.cost || 0} <span style="color:#888;">($${ppp}/pt)</span></div>
                    <div class="heatmap">
                        <div class="seg ${u.owned?'owned':''}"></div>
                        <div class="seg ${u.built?'built':''}"></div>
                        <div class="seg ${u.primed?'primed':''}"></div>
                        <div class="seg ${u.painted?'painted':''}"></div>
                    </div>
                    <div class="hobby-row">
                        <label class="hobby-item"><input type="checkbox" ${u.owned?'checked':''} onchange="toggleHobby(${cIdx}, ${uIdx},'owned')"> Owned</label>
                        <label class="hobby-item"><input type="checkbox" ${u.built?'checked':''} onchange="toggleHobby(${cIdx}, ${uIdx},'built')"> Built</label>
                        <label class="hobby-item"><input type="checkbox" ${u.primed?'checked':''} onchange="toggleHobby(${cIdx}, ${uIdx},'primed')"> Primed</label>
                        <label class="hobby-item"><input type="checkbox" ${u.painted?'checked':''} onchange="toggleHobby(${cIdx}, ${uIdx},'painted')"> Painted</label>
                    </div>
                </div>`;
        }

        function renderUnits() {
            const container = document.getElementById('unitContainer'); container.innerHTML = '';
            const units = army[activeIdx].units;
            ['hero', 'character', 'battleline', 'fire_support', 'close_support', 'vehicle'].forEach(role => {
                let roleUnits = units.filter(u => u.role === role);
                roleUnits.sort((a, b) => a.name.localeCompare(b.name, undefined, {sensitivity: 'base'}));
                if(roleUnits.length > 0) {
                    const h = document.createElement('div'); h.className = 'group-header'; 
                    h.innerHTML = `${role.replace('_', ' ')} <span>(${roleUnits.length})</span>`; 
                    container.appendChild(h);
                    const grid = document.createElement('div'); grid.className = 'unit-grid-container';
                    container.appendChild(grid);
                    roleUnits.forEach(u => {
                        const actualIdx = units.indexOf(u);
                        grid.innerHTML += createUnitCardHTML(u, activeIdx, actualIdx);
                    });
                }
            });
        }

        function toggleFocus(cIdx, uIdx) { army[cIdx].units[uIdx].focused = !army[cIdx].units[uIdx].focused; save(); }
        function toggleHobby(cIdx, uIdx, field) { army[cIdx].units[uIdx][field] = !army[cIdx].units[uIdx][field]; save(); }

        function updateDashboard() {
            let g = { pts: 0, tPts: 0, cost: 0, tCost: 0, owned: 0, built: 0, primed: 0, painted: 0, total: 0 };
            const gal = document.getElementById('dash-gallery'); gal.innerHTML = '';
            const projGrid = document.getElementById('project-grid'); projGrid.innerHTML = '';
            let focusedCount = 0;

            army.forEach((comp, cIdx) => {
                let cPts = 0; let ch = {owned:0, built:0, primed:0, painted:0};
                comp.units.forEach((u, uIdx) => {
                    g.total++; g.tPts += parseInt(u.pts||0); g.tCost += parseInt(u.cost||0);
                    if(u.painted) g.pts += parseInt(u.pts||0);
                    if(u.owned) g.cost += parseInt(u.cost||0);
                    if(u.owned) { g.owned++; ch.owned++; }
                    if(u.built) { g.built++; ch.built++; }
                    if(u.primed) { g.primed++; ch.primed++; }
                    if(u.painted) { g.painted++; ch.painted++; }
                    cPts += parseInt(u.pts||0);

                    if(u.focused) {
                        focusedCount++;
                        projGrid.innerHTML += createUnitCardHTML(u, cIdx, uIdx, true, comp.name);
                    }
                });
                const card = document.createElement('div');
                card.className = 'summary-card';
                card.onclick = () => selectCompany(cIdx);
                card.innerHTML = `<h3>${comp.name}</h3><div class="summary-meta">${comp.units.length} Units ‚Ä¢ ${cPts} Pts</div>${renderBar('Owned', ch.owned, comp.units.length, 'var(--bar-owned)')}${renderBar('Built', ch.built, comp.units.length, 'var(--bar-built)')}${renderBar('Primed', ch.primed, comp.units.length, 'var(--bar-primed)')}${renderBar('Painted', ch.painted, comp.units.length, 'var(--bar-painted)')}`;
                gal.appendChild(card);
            });

            document.getElementById('project-focus-section').style.display = focusedCount > 0 ? 'block' : 'none';
            document.getElementById('global-widgets').innerHTML = renderWidgetSet(g);
        }

        function selectCompany(i) { activeIdx = i; switchView('companies', document.getElementById('nav-comp')); document.getElementById('no-selection').style.display = 'none'; document.getElementById('active-ui').style.display = 'block'; document.getElementById('active-title').innerText = army[i].name; renderCompanyNav(); renderUnits(); updateLocalWidgets(); }
        function updateLocalWidgets() { let s = { pts: 0, tPts: 0, cost: 0, tCost: 0, owned: 0, built: 0, primed: 0, painted: 0, total: 0 }; army[activeIdx].units.forEach(u => { s.total++; s.tPts += parseInt(u.pts||0); s.tCost += parseInt(u.cost||0); if(u.painted) s.pts += parseInt(u.pts||0); if(u.owned) s.cost += parseInt(u.cost||0); if(u.owned) s.owned++; if(u.built) s.built++; if(u.primed) s.primed++; if(u.painted) s.painted++; }); document.getElementById('local-widgets').innerHTML = renderWidgetSet(s); }
        
        function renderWidgetSet(s) { 
            const avgEff = s.tPts > 0 ? (s.tCost / s.tPts).toFixed(2) : "0.00";
            return `
                <div class="widget w-pts"><span class="widget-val">${s.pts}<small style="color:#888; font-size:0.7rem;">/${s.tPts}</small></span><span class="widget-label">Painted Pts</span></div>
                <div class="widget w-val"><span class="widget-val">$${s.cost}<small style="color:#888; font-size:0.7rem;">/$${s.tCost}</small></span><span class="widget-label">Value Owned</span></div>
                <div class="widget w-eff"><span class="widget-val">$${avgEff}<small style="color:#888; font-size:0.7rem;">/pt</small></span><span class="widget-label">Efficiency</span></div>
                <div class="widget w-owned"><span class="widget-val">${s.owned}<small style="color:#888; font-size:0.7rem;">/${s.total}</small></span><span class="widget-label">Owned</span></div>
                <div class="widget w-built"><span class="widget-val">${s.built}<small style="color:#888; font-size:0.7rem;">/${s.total}</small></span><span class="widget-label">Built</span></div>
                <div class="widget w-painted"><span class="widget-val">${s.painted}<small style="color:#888; font-size:0.7rem;">/${s.total}</small></span><span class="widget-label">Painted</span></div>`; 
        }

        function renderBar(l, v, t, c) { const p = t > 0 ? Math.round((v/t)*100) : 0; return `<div style="margin-bottom:8px;"><div class="bar-label"><span>${l}</span><span>${p}%</span></div><div style="background:var(--bg-dark); height:5px; border-radius:10px; overflow:hidden; margin-top:3px;"><div style="width:${p}%; background:${c}; height:100%;"></div></div></div>`; }
        function duplicateUnit(i) { const clone = JSON.parse(JSON.stringify(army[activeIdx].units[i])); army[activeIdx].units.push(clone); save(); }
        function editUnit(i) { editingUnitIdx = i; const u = army[activeIdx].units[i]; document.getElementById('uName').value = u.name; document.getElementById('uRole').value = u.role; document.getElementById('uModels').value = u.models; document.getElementById('uPts').value = u.pts; document.getElementById('uCost').value = u.cost; togglePanel(true); document.getElementById('companies').scrollTo({ top: 0, behavior: 'smooth' }); document.getElementById('uName').focus(); }
        function openPanel() { editingUnitIdx = null; document.getElementById('uName').value = ''; ['uModels','uPts','uCost'].forEach(id => document.getElementById(id).value = ''); togglePanel(true); document.getElementById('companies').scrollTo({ top: 0, behavior: 'smooth' }); document.getElementById('uName').focus(); }
        
        function renderCompanyNav() { 
            const nav = document.getElementById('comp-nav'); nav.innerHTML = ''; 
            army.forEach((c, i) => { 
                const div = document.createElement('div'); div.className = `comp-nav-item ${activeIdx === i ? 'active' : ''}`; 
                div.innerHTML = `
                    <div style="display:flex; flex-direction:column; margin-right:10px; opacity:0.3;">
                        <button onclick="moveCompany(${i}, -1, event)" style="background:none; border:none; color:var(--text-main); font-size:0.6rem; cursor:pointer; padding:0;">‚ñ≤</button>
                        <button onclick="moveCompany(${i}, 1, event)" style="background:none; border:none; color:var(--text-main); font-size:0.6rem; cursor:pointer; padding:0;">‚ñº</button>
                    </div>
                    <span style="flex:1; cursor:pointer;" onclick="selectCompany(${i})">${c.name}</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span title="Edit" onclick="renameCompany(${i}, event)" style="opacity:0.6; cursor:pointer; font-size:0.8rem;">‚úé</span>
                        <span title="Duplicate" onclick="duplicateCompany(${i}, event)" style="opacity:0.6; cursor:pointer; font-size:0.85rem;">‚ùê</span>
                        <span title="Delete" onclick="delComp(${i},event)" style="opacity:0.4; cursor:pointer;">‚úï</span>
                    </div>`; 
                nav.appendChild(div); 
            }); 
        }

        function moveCompany(index, direction, e) { e.stopPropagation(); const newIndex = index + direction; if (newIndex < 0 || newIndex >= army.length) return; const temp = army[index]; army[index] = army[newIndex]; army[newIndex] = temp; if (activeIdx === index) activeIdx = newIndex; else if (activeIdx === newIndex) activeIdx = index; save(); }
        function renameCompany(i, e) { e.stopPropagation(); const n = prompt("Rename Company:", army[i].name); if (n && n.trim()) { army[i].name = n.trim(); save(); if (activeIdx === i) document.getElementById('active-title').innerText = army[i].name; } }
        function duplicateCompany(i, e) { e.stopPropagation(); const clone = JSON.parse(JSON.stringify(army[i])); clone.name = "Copy of " + clone.name; army.push(clone); save(); }
        function saveUnit() { const data = { name: document.getElementById('uName').value, role: document.getElementById('uRole').value, models: parseInt(document.getElementById('uModels').value) || 0, pts: parseInt(document.getElementById('uPts').value) || 0, cost: parseInt(document.getElementById('uCost').value) || 0 }; if(editingUnitIdx !== null) { Object.assign(army[activeIdx].units[editingUnitIdx], data); } else { data.owned = true; data.built = false; data.primed = false; data.painted = false; data.focused = false; army[activeIdx].units.push(data); } save(); togglePanel(false); }
        function delUnit(i) { if(confirm("Delete unit?")) { army[activeIdx].units.splice(i,1); save(); } }
        function createNewCompany() { const n = prompt("Name:"); if(n) { army.push({name:n, units:[]}); save(); } }
        function delComp(i, e) { e.stopPropagation(); if(confirm("Delete Company?")) { army.splice(i,1); activeIdx = null; save(); location.reload(); } }
        function togglePanel(s) { document.getElementById('unitPanel').style.display = s ? 'block' : 'none'; }
        function exportData() { navigator.clipboard.writeText(JSON.stringify(army)).then(() => alert("Army data copied!")); }
        function importData() { const code = prompt("Paste save code:"); if (code) { try { const p = JSON.parse(code); if (Array.isArray(p)) { army = p; save(); location.reload(); } } catch (e) { alert("Error."); } } }
    </script>
</body>
</html>

